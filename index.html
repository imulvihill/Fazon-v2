<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fazon Penguin</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/show/134449/penguin.svg">
    <link rel="apple-touch-icon" href="https://www.svgrepo.com/show/134449/penguin.svg">
    <meta name="theme-color" content="#1f2937">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fazon Penguin">
    <meta name="application-name" content="Fazon Penguin">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --nav-bg: #1f2937;
            --nav-text: #e5e7eb;
            --nav-active-bg: #374151;
            --nav-active-text: #ffffff;
            --content-bg: #f3f4f6;
            --card-bg: #ffffff;
            --primary-text: #111827;
            --secondary-text: #6b7280;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--content-bg);
            color: var(--primary-text);
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .content { padding: 20px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2, h3 { margin-top: 0; font-weight: 600; }
        input, select, button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
        }
        select:disabled { background-color: #e5e7eb; }
        button {
            cursor: pointer;
            color: white;
            border: none;
            font-weight: 500;
            background-color: var(--accent-color);
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-pdf { background-color: var(--secondary-text); }
        .btn-small { padding: 6px 10px; font-size: 12px; margin: 0 4px 0 0; width: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 8px;
            text-align: left;
            font-size: 14px;
        }
        th { font-weight: 600; }
        .text-right { text-align: right; }
        .actions-cell { width: 1%; white-space: nowrap; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex;
            background-color: var(--nav-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-item {
            flex: 1; padding: 10px 0;
            text-align: center; color: var(--nav-text);
            cursor: pointer; font-size: 12px;
            transition: background-color 0.2s;
        }
        .nav-item.icon { font-size: 24px; }
        .nav-item.active {
            background-color: var(--nav-active-bg);
            color: var(--nav-active-text);
        }
    </style>
</head>
<body>

    <main class="content">
        <div id="page-ventas" class="page active">
            <h2>🐧 Módulo de Ventas</h2>
            <div class="card">
                <h3 id="formVentaTitle">Nueva Venta de Tueste</h3>
                <form id="formVenta">
                    <select id="ventaCliente" required><option value="">-- Seleccionar Cliente --</option></select>
                    <select id="ventaStockLote" required disabled><option value="">-- Primero seleccione un cliente --</option></select>
                    <input type="date" id="ventaFecha" required>
                    <input type="number" step="0.01" id="ventaKg" placeholder="Cantidad de Kg a tostar" required>
                    <input type="number" step="0.01" id="ventaPrecioUSD" placeholder="Precio por Kg (USD)" required>
                    <input type="number" step="0.01" id="ventaTipoCambio" placeholder="Tipo de cambio del día" required>
                    <input type="number" id="ventaBultos" placeholder="Cantidad de bultos envasados" required>
                    <input type="number" step="0.01" id="ventaCostoEnvioPorBulto" placeholder="Costo Envío por Bulto (ARS) - Opcional">
                    <button type="submit" id="btnGuardarVenta">Registrar Venta</button>
                    <button type="button" id="btnCancelarEdicionVenta" class="btn-warning" style="display:none;">Cancelar Edición</button>
                </form>
            </div>
            <div class="card">
                <h3>Historial de Ventas</h3>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Fecha</th><th>Cliente</th><th>Kg</th><th>Total ARS</th><th>Acciones</th></tr></thead><tbody id="tablaVentas"></tbody></table>
                </div>
            </div>
        </div>

        <div id="page-cobros" class="page">
            <h2>Módulo de Cobros y Cuentas Corrientes</h2>
            <div class="card">
                <h3>Registrar Cobro</h3>
                <form id="formCobro">
                    <select id="cobroCliente" required><option value="">-- Seleccionar Cliente --</option></select>
                    <input type="date" id="cobroFecha" required>
                    <input type="number" step="0.01" id="cobroMonto" placeholder="Monto cobrado (ARS)" required>
                    <button type="submit" class="btn-success">Registrar Cobro</button>
                </form>
            </div>
            <div class="card">
                <h3>Cuentas Corrientes de Clientes</h3>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Cliente</th><th class="text-right">Saldo Deudor (ARS)</th></tr></thead><tbody id="tablaCuentasCorrientes"></tbody></table>
                </div>
            </div>
             <div class="card">
                <h3>Historial de Cobros</h3>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Fecha</th><th>Cliente</th><th>Monto</th><th>Acciones</th></tr></thead><tbody id="tablaCobros"></tbody></table>
                </div>
            </div>
            <div class="card">
                <h3>Reporte de Cuenta Corriente</h3>
                <form id="formReporteCuentaCorriente">
                    <select id="reporteCuentaCorrienteCliente" required><option value="">-- Seleccionar Cliente --</option></select>
                    <button type="submit" class="btn-pdf">Generar PDF de Saldo</button>
                </form>
            </div>
        </div>
        
        <div id="page-tipos-cafe" class="page">
            <h2>Módulo de Tipos de Café</h2>
            <div class="card">
                <h3 id="formTipoCafeTitle">Agregar Tipo de Café</h3>
                <form id="formTipoCafe">
                    <input type="text" id="tipoCafeNombre" placeholder="Nombre del café (Ej: Colombia Excelso)" required>
                    <button type="submit" id="btnGuardarTipoCafe">Guardar Tipo de Café</button>
                    <button type="button" id="btnCancelarEdicionTipoCafe" class="btn-warning" style="display:none;">Cancelar Edición</button>
                </form>
            </div>
            <div class="card">
                <h3>Listado</h3>
                <table><thead><tr><th>Nombre</th><th>Acciones</th></tr></thead><tbody id="tablaTiposCafe"></tbody></table>
            </div>
        </div>

        <div id="page-clientes" class="page">
            <h2>Módulo de Clientes</h2>
            <div class="card">
                <h3 id="formClienteTitle">Agregar Cliente</h3>
                <form id="formCliente">
                    <input type="text" id="clienteNombre" placeholder="Nombre del cliente" required>
                    <button type="submit" id="btnGuardarCliente">Guardar Cliente</button>
                    <button type="button" id="btnCancelarEdicion" class="btn-warning" style="display:none;">Cancelar Edición</button>
                </form>
            </div>
            <div class="card">
                <h3>Listado</h3>
                <table><thead><tr><th>Nombre</th><th>Acciones</th></tr></thead><tbody id="tablaClientes"></tbody></table>
            </div>
        </div>

        <div id="page-logistica" class="page">
            <h2>Módulo de Logística</h2>
            <div class="card">
                <h3>Historial de Costos de Envío</h3>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Fecha</th><th>Cliente</th><th>Concepto</th><th class="text-right">Monto</th><th>Acciones</th></tr></thead><tbody id="tablaLogistica"></tbody></table>
                </div>
            </div>
        </div>

        <div id="page-stock" class="page">
            <h2>Módulo de Stock</h2>
            <div class="card">
                <h3>Ingresar Café Verde</h3>
                <form id="formStock">
                    <select id="stockCliente" required><option value="">-- Cliente Dueño del Café --</option></select>
                    <select id="stockTipoCafe" required><option value="">-- Seleccione Tipo de Café --</option></select>
                    <input type="date" id="stockFecha" required>
                    <input type="number" id="stockBultos" placeholder="N° de Bultos" required>
                    <input type="number" step="0.01" id="stockKgPorBulto" placeholder="Kg por Bulto" required>
                    <input type="number" step="0.01" id="stockCostoEnvioPorBulto" placeholder="Costo Envío por Bulto (ARS) - Opcional">
                    <button type="submit" class="btn-success">Ingresar Stock</button>
                </form>
            </div>
            <div class="card">
                <h3>Stock Actual de Café Verde</h3>
                <div style="overflow-x:auto;">
                    <table><thead><tr><th>Cliente</th><th>Café</th><th>Kg Restantes</th><th>Acciones</th></tr></thead><tbody id="tablaStock"></tbody></table>
                </div>
            </div>
            <div class="card">
                <h3>Reporte de Stock por Cliente</h3>
                <form id="formReporteStock">
                    <select id="reporteStockCliente" required><option value="">-- Seleccionar Cliente --</option></select>
                    <button type="submit" class="btn-pdf">Generar PDF</button>
                </form>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" data-page="ventas"><div class="icon">🛒</div><div>Ventas</div></div>
        <div class="nav-item" data-page="cobros"><div class="icon">💲</div><div>Cobros</div></div>
        <div class="nav-item" data-page="tipos-cafe"><div class="icon">☕</div><div>Cafés</div></div>
        <div class="nav-item" data-page="clientes"><div class="icon">👥</div><div>Clientes</div></div>
        <div class="nav-item" data-page="logistica"><div class="icon">🚚</div><div>Logística</div></div>
        <div class="nav-item" data-page="stock"><div class="icon">📦</div><div>Stock</div></div>
    </nav>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & DB ---
    let editingState = { type: null, index: -1 };
    let ventaEnEdicion = null;
    let clientes = JSON.parse(localStorage.getItem('fazon_clientes')) || [];
    let stock = JSON.parse(localStorage.getItem('fazon_stock')) || [];
    let ventas = JSON.parse(localStorage.getItem('fazon_ventas')) || [];
    let cobros = JSON.parse(localStorage.getItem('fazon_cobros')) || [];
    let logistica = JSON.parse(localStorage.getItem('fazon_logistica')) || [];
    let tiposCafe = JSON.parse(localStorage.getItem('fazon_tipos_cafe')) || [];

    const saveData = () => {
        localStorage.setItem('fazon_clientes', JSON.stringify(clientes));
        localStorage.setItem('fazon_stock', JSON.stringify(stock));
        localStorage.setItem('fazon_ventas', JSON.stringify(ventas));
        localStorage.setItem('fazon_cobros', JSON.stringify(cobros));
        localStorage.setItem('fazon_logistica', JSON.stringify(logistica));
        localStorage.setItem('fazon_tipos_cafe', JSON.stringify(tiposCafe));
    };

    // --- DATA MIGRATION ---
    const migrateStockDescriptions = () => {
        let migrationNeeded = false;
        stock.forEach(item => {
            if (item.descripcion && !item.tipoCafeId) {
                migrationNeeded = true;
                let tipo = tiposCafe.find(t => t.nombre.toLowerCase() === item.descripcion.toLowerCase());
                if (!tipo) {
                    tipo = { id: Date.now() + Math.random(), nombre: item.descripcion };
                    tiposCafe.push(tipo);
                }
                item.tipoCafeId = tipo.id;
                delete item.descripcion;
            }
        });
        if (migrationNeeded) {
            console.log("Migración de datos de stock completada.");
            saveData();
        }
    };
    
    // --- NAVIGATION ---
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        navItems.forEach(n => n.classList.remove('active'));
        document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
    }
    navItems.forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));

    // --- HELPERS ---
    const formatCurrency = (number) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(number);
    const formatDate = (dateString) => new Date(dateString + 'T00:00:00').toLocaleDateString('es-AR');

    // --- UI RENDERING ---
    function renderUI() {
        const clientSelects = ['ventaCliente', 'cobroCliente', 'stockCliente', 'reporteCuentaCorrienteCliente', 'reporteStockCliente'];
        clientSelects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            const selectedValue = select.value;
            select.innerHTML = `<option value="">-- Seleccionar Cliente --</option>`;
            clientes.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(c => select.add(new Option(c.nombre, c.id)));
            if (clientes.some(c => c.id == selectedValue)) select.value = selectedValue;
        });
        
        const tipoCafeSelect = document.getElementById('stockTipoCafe');
        const selectedTipoCafe = tipoCafeSelect.value;
        tipoCafeSelect.innerHTML = '<option value="">-- Seleccione Tipo de Café --</option>';
        tiposCafe.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(t => tipoCafeSelect.add(new Option(t.nombre, t.id)));
        if (tiposCafe.some(t => t.id == selectedTipoCafe)) tipoCafeSelect.value = selectedTipoCafe;
        
        const tablaTiposCafe = document.getElementById('tablaTiposCafe');
        tablaTiposCafe.innerHTML = '';
        tiposCafe.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(t => {
            const originalIndex = tiposCafe.findIndex(item => item.id === t.id);
            tablaTiposCafe.innerHTML += `<tr>
                <td>${t.nombre}</td>
                <td class="actions-cell">
                    <button class="btn-small btn-warning" onclick="editItem('tipoCafe', ${originalIndex})">Editar</button>
                    <button class="btn-small btn-danger" onclick="deleteItem('tipoCafe', ${originalIndex})">X</button>
                </td>
            </tr>`;
        });

        const tablaClientes = document.getElementById('tablaClientes');
        tablaClientes.innerHTML = '';
        clientes.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
            const originalIndex = clientes.findIndex(item => item.id === c.id);
            tablaClientes.innerHTML += `<tr>
                <td>${c.nombre}</td>
                <td class="actions-cell">
                    <button class="btn-small btn-warning" onclick="editItem('cliente', ${originalIndex})">Editar</button>
                    <button class="btn-small btn-danger" onclick="deleteItem('cliente', ${originalIndex})">X</button>
                </td>
            </tr>`;
        });
        
        const tablaStock = document.getElementById('tablaStock');
        tablaStock.innerHTML = '';
        stock.forEach((s, i) => {
            if (s.kgActuales > 0.001) {
                const cliente = clientes.find(c => c.id == s.clienteId);
                const tipoCafe = tiposCafe.find(t => t.id == s.tipoCafeId);
                tablaStock.innerHTML += `<tr>
                    <td>${cliente?.nombre || 'N/A'}</td>
                    <td>${tipoCafe?.nombre || 'DESCONOCIDO'}</td>
                    <td>${s.kgActuales.toFixed(2)} Kg</td>
                    <td class="actions-cell">
                        <button class="btn-small btn-pdf" onclick="generateStockPdf(${i})">Detalle</button>
                        <button class="btn-small btn-warning" onclick="editItem('stock', ${i})">Editar Fecha</button>
                        <button class="btn-small btn-danger" onclick="deleteItem('stock', ${i})">X</button>
                    </td>
                </tr>`;
            }
        });

        const tablaVentas = document.getElementById('tablaVentas');
        tablaVentas.innerHTML = '';
        ventas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(v => {
            const originalIndex = ventas.indexOf(v);
            const cliente = clientes.find(c => c.id == v.clienteId);
            tablaVentas.innerHTML += `<tr>
                <td>${formatDate(v.fecha)}</td>
                <td>${cliente?.nombre || 'N/A'}</td>
                <td>${v.kg} Kg</td>
                <td class="text-right">${formatCurrency(v.totalARS)}</td>
                <td class="actions-cell">
                    <button class="btn-small btn-warning" onclick="editVenta(${originalIndex})">Editar</button>
                    <button class="btn-small btn-pdf" onclick="generateRoastOrderPdf(${originalIndex})">Orden</button>
                    <button class="btn-small btn-danger" onclick="deleteItem('venta', ${originalIndex})">Borrar</button>
                </td>
            </tr>`;
        });
        
        const tablaLogistica = document.getElementById('tablaLogistica');
        tablaLogistica.innerHTML = '';
        logistica.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(l => {
            const originalIndex = logistica.indexOf(l);
            const cliente = clientes.find(c => c.id == l.clienteId);
            tablaLogistica.innerHTML += `<tr>
                <td>${formatDate(l.fecha)}</td>
                <td>${cliente?.nombre || 'N/A'}</td>
                <td>${l.descripcion}</td>
                <td class="text-right">${formatCurrency(l.monto)}</td>
                <td class="actions-cell">
                     <button class="btn-small btn-danger" onclick="deleteItem('logistica', ${originalIndex})">Borrar</button>
                </td>
            </tr>`;
        });

        const tablaCobros = document.getElementById('tablaCobros');
        tablaCobros.innerHTML = '';
        cobros.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).forEach((cob) => {
            const originalIndex = cobros.indexOf(cob);
            const cliente = clientes.find(c => c.id == cob.clienteId);
            tablaCobros.innerHTML += `<tr>
                <td>${formatDate(cob.fecha)}</td>
                <td>${cliente?.nombre || 'N/A'}</td>
                <td>${formatCurrency(cob.monto)}</td>
                <td class="actions-cell">
                    <button class="btn-small btn-danger" onclick="deleteItem('cobro', ${originalIndex})">Borrar</button>
                </td>
            </tr>`;
        });

        const tablaCuentasCorrientes = document.getElementById('tablaCuentasCorrientes');
        tablaCuentasCorrientes.innerHTML = '';
        clientes.forEach(c => {
            const totalVentas = ventas.filter(v => v.clienteId == c.id).reduce((sum, v) => sum + v.totalARS, 0);
            const totalLogistica = logistica.filter(l => l.clienteId == c.id).reduce((sum, l) => sum + l.monto, 0);
            const totalCobros = cobros.filter(cob => cob.clienteId == c.id).reduce((sum, cob) => sum + cob.monto, 0);
            const saldo = totalVentas + totalLogistica - totalCobros;
            if (Math.abs(saldo) > 0.01) {
                tablaCuentasCorrientes.innerHTML += `<tr>
                    <td>${c.nombre}</td>
                    <td class="text-right" style="color:white; padding: 5px; background-color:${saldo > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">
                        ${formatCurrency(saldo)}
                    </td>
                </tr>`;
            }
        });
    }

    // --- FORM LOGIC & EVENT LISTENERS ---
    const setupForm = (formId, titleId, inputId, buttonId, cancelButtonId, collection, entityName, entityKey) => {
        const form = document.getElementById(formId);
        const title = document.getElementById(titleId);
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const cancelButton = document.getElementById(cancelButtonId);

        const resetForm = () => {
            editingState = { type: null, index: -1 };
            title.textContent = `Agregar ${entityName}`;
            button.textContent = `Guardar ${entityName}`;
            cancelButton.style.display = 'none';
            form.reset();
        };

        form.addEventListener('submit', e => {
            e.preventDefault();
            const nombre = input.value.trim();
            if (!nombre) return;

            if (editingState.type === entityKey) {
                collection[editingState.index].nombre = nombre;
                alert(`${entityName} actualizado!`);
            } else {
                collection.push({ id: Date.now(), nombre });
                alert(`${entityName} agregado!`);
            }
            resetForm();
            saveData();
            renderUI();
        });
        cancelButton.addEventListener('click', resetForm);
    };

    setupForm('formCliente', 'formClienteTitle', 'clienteNombre', 'btnGuardarCliente', 'btnCancelarEdicion', clientes, 'Cliente', 'cliente');
    setupForm('formTipoCafe', 'formTipoCafeTitle', 'tipoCafeNombre', 'btnGuardarTipoCafe', 'btnCancelarEdicionTipoCafe', tiposCafe, 'Tipo de Café', 'tipoCafe');


    document.getElementById('formStock').addEventListener('submit', e => {
        e.preventDefault();
        const kgPorBulto = parseFloat(document.getElementById('stockKgPorBulto').value);
        const bultos = parseInt(document.getElementById('stockBultos').value);
        const totalKg = kgPorBulto * bultos;
        const costoEnvioPorBulto = parseFloat(document.getElementById('stockCostoEnvioPorBulto').value) || 0;
        const costoEnvioTotal = costoEnvioPorBulto * bultos;
        const clienteId = document.getElementById('stockCliente').value;
        const tipoCafeId = document.getElementById('stockTipoCafe').value;
        const fecha = document.getElementById('stockFecha').value;

        if (!clienteId || !tipoCafeId || !fecha || isNaN(totalKg) || totalKg <= 0) {
            alert('Error: Verifique que todos los campos estén completos.'); return;
        }
        
        const tipoCafeSeleccionado = tiposCafe.find(t => t.id == tipoCafeId);
        const nuevoLote = {
            id: Date.now(), clienteId, tipoCafeId, fechaIngreso: fecha,
            kgIniciales: totalKg, kgActuales: totalKg,
            movimientos: [{ fecha: fecha, tipo: 'Ingreso', kg: totalKg }]
        };
        stock.push(nuevoLote);

        if (costoEnvioTotal > 0) {
            logistica.push({
                id: Date.now() + 1, clienteId, fecha: nuevoLote.fechaIngreso,
                descripcion: `Envío Ingreso: ${tipoCafeSeleccionado.nombre}`,
                monto: costoEnvioTotal, loteId: nuevoLote.id
            });
        }
        saveData(); renderUI(); e.target.reset();
        alert(`Stock ingresado: ${totalKg.toFixed(2)} Kg.`);
    });
    
    document.getElementById('formCobro').addEventListener('submit', e => {
        e.preventDefault();
        cobros.push({
            id: Date.now(), clienteId: document.getElementById('cobroCliente').value,
            fecha: document.getElementById('cobroFecha').value,
            monto: parseFloat(document.getElementById('cobroMonto').value),
        });
        saveData(); renderUI(); e.target.reset();
        alert('Cobro registrado!');
    });
    
    // --- VENTA FORM LOGIC (INCLUYE EDICIÓN) ---
    const formVenta = document.getElementById('formVenta');
    const ventaClienteSelect = document.getElementById('ventaCliente');
    
    const resetVentaForm = () => {
        ventaEnEdicion = null;
        formVenta.reset();
        document.getElementById('formVentaTitle').textContent = 'Nueva Venta de Tueste';
        document.getElementById('btnGuardarVenta').textContent = 'Registrar Venta';
        document.getElementById('btnCancelarEdicionVenta').style.display = 'none';
        document.getElementById('ventaStockLote').disabled = true;
        document.getElementById('ventaStockLote').innerHTML = '<option value="">-- Primero seleccione un cliente --</option>';
    };

    ventaClienteSelect.addEventListener('change', (e) => {
        const clienteId = e.target.value;
        const stockSelect = document.getElementById('ventaStockLote');
        stockSelect.innerHTML = '<option value="">-- Seleccione un lote de café --</option>';
        if (!clienteId) { stockSelect.disabled = true; return; }
        
        const stockDisponible = stock.filter(s => s.clienteId == clienteId && s.kgActuales > 0.001);
        
        if (ventaEnEdicion && ventaEnEdicion.clienteId.toString() === clienteId) {
            const loteOriginal = stock.find(s => s.id === ventaEnEdicion.stockIdDescontado);
            if (loteOriginal && !stockDisponible.some(s => s.id === loteOriginal.id)) {
                stockDisponible.push(loteOriginal);
            }
        }
        
        if (stockDisponible.length === 0) {
            stockSelect.disabled = true;
            stockSelect.innerHTML = '<option value="">-- No hay stock disponible --</option>';
        } else {
            stockDisponible.forEach(s => {
                const tipoCafe = tiposCafe.find(t => t.id == s.tipoCafeId);
                let currentKg = s.kgActuales;
                if (ventaEnEdicion && s.id === ventaEnEdicion.stockIdDescontado) {
                    currentKg += ventaEnEdicion.kg;
                }
                const optionText = `${tipoCafe?.nombre || 'N/A'} (${currentKg.toFixed(2)} Kg disp.)`;
                stockSelect.add(new Option(optionText, s.id));
            });
            stockSelect.disabled = false;
        }
    });

    formVenta.addEventListener('submit', e => {
        e.preventDefault();
        const kgATostar = parseFloat(document.getElementById('ventaKg').value);
        const stockLoteId = document.getElementById('ventaStockLote').value;
        const loteSeleccionado = stock.find(s => s.id == stockLoteId);
        
        let stockDisponibleParaVenta = loteSeleccionado?.kgActuales || 0;
        if(ventaEnEdicion && loteSeleccionado?.id === ventaEnEdicion.stockIdDescontado) {
            stockDisponibleParaVenta += ventaEnEdicion.kg;
        }
        
        if (!loteSeleccionado || isNaN(kgATostar) || kgATostar <= 0) { alert('Error: Verifique los datos.'); return; }
        if (kgATostar > stockDisponibleParaVenta) { alert(`Error: Stock insuficiente. Disponible: ${stockDisponibleParaVenta.toFixed(2)} Kg.`); return; }

        if (ventaEnEdicion) {
            const loteOriginal = stock.find(s => s.id == ventaEnEdicion.stockIdDescontado);
            if (loteOriginal) {
                loteOriginal.kgActuales += ventaEnEdicion.kg;
                loteOriginal.movimientos = loteOriginal.movimientos.filter(m => m.ventaId !== ventaEnEdicion.id);
            }
            logistica = logistica.filter(l => l.ventaId !== ventaEnEdicion.id);
            const indexToRemove = ventas.findIndex(v => v.id === ventaEnEdicion.id);
            if (indexToRemove > -1) ventas.splice(indexToRemove, 1);
        }

        const bultos = parseInt(document.getElementById('ventaBultos').value);
        const costoEnvioPorBulto = parseFloat(document.getElementById('ventaCostoEnvioPorBulto').value) || 0;
        const costoEnvioDespachoTotal = costoEnvioPorBulto * bultos;
        const precioUSD = parseFloat(document.getElementById('ventaPrecioUSD').value);
        const tipoCambio = parseFloat(document.getElementById('ventaTipoCambio').value);
        
        const nuevaVenta = {
            id: ventaEnEdicion?.id || Date.now(), clienteId: document.getElementById('ventaCliente').value,
            fecha: document.getElementById('ventaFecha').value, kg: kgATostar, precioUSD, tipoCambio, bultos,
            totalARS: kgATostar * precioUSD * tipoCambio, stockIdDescontado: stockLoteId
        };
        
        loteSeleccionado.kgActuales -= kgATostar;
        loteSeleccionado.movimientos.push({ fecha: nuevaVenta.fecha, tipo: 'Venta Tueste', kg: -kgATostar, ventaId: nuevaVenta.id });
        ventas.push(nuevaVenta);

        if (costoEnvioDespachoTotal > 0) {
            logistica.push({
                id: Date.now() + 1, clienteId: nuevaVenta.clienteId, fecha: nuevaVenta.fecha,
                descripcion: `Envío Despacho Tueste`, monto: costoEnvioDespachoTotal, ventaId: nuevaVenta.id
            });
        }
        
        alert(ventaEnEdicion ? 'Venta actualizada con éxito!' : 'Venta registrada con éxito!');
        resetVentaForm();
        saveData();
        renderUI();
    });
    
    document.getElementById('btnCancelarEdicionVenta').addEventListener('click', resetVentaForm);

    document.getElementById('formReporteCuentaCorriente').addEventListener('submit', e => {
        e.preventDefault();
        const clienteId = document.getElementById('reporteCuentaCorrienteCliente').value;
        if (!clienteId) { alert('Por favor, seleccione un cliente.'); return; }
        generateCuentaCorrientePdf(clienteId);
    });
    
    document.getElementById('formReporteStock').addEventListener('submit', e => {
        e.preventDefault();
        const clienteId = document.getElementById('reporteStockCliente').value;
        if (!clienteId) { alert('Por favor, seleccione un cliente.'); return; }
        generateConsolidatedStockPdf(clienteId);
    });

    // --- ACTIONS (EDIT / DELETE / PDF) ---
    window.editVenta = (index) => {
        ventaEnEdicion = { ...ventas[index], originalIndex: index };
        document.getElementById('formVentaTitle').textContent = 'Editando Venta';
        document.getElementById('btnGuardarVenta').textContent = 'Actualizar Venta';
        document.getElementById('btnCancelarEdicionVenta').style.display = 'block';
        const v = ventaEnEdicion;
        const ventaClienteSelect = document.getElementById('ventaCliente');
        ventaClienteSelect.value = v.clienteId;
        ventaClienteSelect.dispatchEvent(new Event('change'));
        document.getElementById('ventaStockLote').value = v.stockIdDescontado;
        document.getElementById('ventaFecha').value = v.fecha;
        document.getElementById('ventaKg').value = v.kg;
        document.getElementById('ventaPrecioUSD').value = v.precioUSD;
        document.getElementById('ventaTipoCambio').value = v.tipoCambio;
        document.getElementById('ventaBultos').value = v.bultos;
        const costoEnvio = logistica.find(l => l.ventaId === v.id);
        document.getElementById('ventaCostoEnvioPorBulto').value = (costoEnvio && v.bultos > 0) ? (costoEnvio.monto / v.bultos) : '';
        formVenta.scrollIntoView({ behavior: 'smooth' });
    };
    
    window.editItem = (type, index) => {
        const entityMap = {
            'cliente': { collection: clientes, page: 'clientes', formId: 'formCliente', inputId: 'clienteNombre', key: 'cliente', name: 'Cliente' },
            'tipoCafe': { collection: tiposCafe, page: 'tipos-cafe', formId: 'formTipoCafe', inputId: 'tipoCafeNombre', key: 'tipoCafe', name: 'Tipo de Café' },
        };

        if (entityMap[type]) {
            const config = entityMap[type];
            editingState = { type: config.key, index };
            const item = config.collection[index];
            document.getElementById(config.inputId).value = item.nombre;
            document.getElementById(config.formId.replace('form','form') + 'Title').textContent = `Editando ${config.name}`;
            document.getElementById(config.formId.replace('form','btnGuardar')).textContent = `Actualizar`;
            document.getElementById(config.formId.replace('form','btnCancelarEdicion')).style.display = 'block';
            showPage(config.page);
            document.getElementById(config.inputId).focus();
        }
        
        if (type === 'stock') {
            const item = stock[index];
            const nuevaFecha = prompt("Editar fecha de ingreso (YYYY-MM-DD):", item.fechaIngreso);
            if (nuevaFecha && /^\d{4}-\d{2}-\d{2}$/.test(nuevaFecha)) {
                item.fechaIngreso = nuevaFecha;
                saveData(); renderUI(); alert('Fecha del lote actualizada.');
            } else if (nuevaFecha) {
                alert("Formato de fecha inválido. Use AAAA-MM-DD.");
            }
        }
    };

    window.deleteItem = (type, index) => {
        let item, name;
        switch(type) {
            case 'cliente':
                item = clientes[index]; name = item.nombre;
                if (confirm(`¿Seguro que quieres eliminar al cliente "${name}"? Se borrarán todas sus transacciones asociadas.`)) {
                    const id = item.id; clientes.splice(index, 1);
                    ventas = ventas.filter(v => v.clienteId != id); stock = stock.filter(s => s.clienteId != id);
                    cobros = cobros.filter(c => c.clienteId != id); logistica = logistica.filter(l => l.clienteId != id);
                }
                break;
            case 'tipoCafe':
                item = tiposCafe[index]; name = item.nombre;
                if (stock.some(s => s.tipoCafeId == item.id)) {
                    alert(`No se puede eliminar "${name}" porque está siendo usado en un lote de stock.`); return;
                }
                if (confirm(`¿Seguro que quieres eliminar el tipo de café "${name}"?`)) { tiposCafe.splice(index, 1); }
                break;
            case 'stock':
                item = stock[index];
                const tipo = tiposCafe.find(t => t.id == item.tipoCafeId); name = tipo?.nombre || "desconocido";
                if (confirm(`¿Seguro que quieres eliminar el lote de "${name}"? Las ventas asociadas NO se revertirán.`)) {
                    logistica = logistica.filter(l => l.loteId !== item.id); stock.splice(index, 1);
                }
                break;
            case 'venta':
                item = ventas[index];
                if (confirm(`¿Seguro que quieres eliminar esta venta? Los ${item.kg} Kg se devolverán al stock.`)) {
                    const lote = stock.find(s => s.id == item.stockIdDescontado);
                    if (lote) {
                        lote.kgActuales += item.kg;
                        lote.movimientos = lote.movimientos.filter(m => m.ventaId !== item.id);
                    }
                    logistica = logistica.filter(l => l.ventaId !== item.id); ventas.splice(index, 1);
                }
                break;
            case 'cobro':
                item = cobros[index];
                if (confirm(`¿Seguro que quieres eliminar este cobro de ${formatCurrency(item.monto)}?`)) { cobros.splice(index, 1); }
                break;
            case 'logistica':
                 item = logistica[index];
                 if (confirm(`¿Seguro que quieres eliminar este costo de logística de ${formatCurrency(item.monto)}?`)) { logistica.splice(index, 1); }
                break;
        }
        saveData();
        renderUI();
    };

    window.generateRoastOrderPdf = (saleIndex) => {
        const sale = ventas[saleIndex];
        if (!sale) { alert('Venta no encontrada.'); return; }

        const cliente = clientes.find(c => c.id == sale.clienteId);
        const stockLote = stock.find(s => s.id == sale.stockIdDescontado);
        const tipoCafe = stockLote ? tiposCafe.find(t => t.id == stockLote.tipoCafeId) : null;

        if (!cliente || !tipoCafe) { alert('No se pudieron encontrar los detalles del cliente o del café.'); return; }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        let y = 20;

        pdf.setFontSize(22); pdf.setFont('helvetica', 'bold'); pdf.text('Orden de Tueste', 105, y, { align: 'center' }); y += 15;
        pdf.setFontSize(12); pdf.setFont('helvetica', 'normal');
        pdf.text(`Fecha: ${formatDate(sale.fecha)}`, 14, y); y += 15;

        pdf.setFontSize(14); pdf.text(`Cliente:`, 14, y); pdf.setFont('helvetica', 'bold'); pdf.text(cliente.nombre, 40, y); y += 10;
        pdf.setFont('helvetica', 'normal'); pdf.text(`Café a Tostar:`, 14, y); pdf.setFont('helvetica', 'bold'); pdf.text(tipoCafe.nombre, 45, y); y += 10;
        pdf.setFont('helvetica', 'normal'); pdf.text(`Cantidad:`, 14, y); pdf.setFont('helvetica', 'bold'); pdf.text(`${sale.kg.toFixed(2)} Kg`, 40, y); y += 15;
        pdf.setFont('helvetica', 'normal'); pdf.text(`Envasar en:`, 14, y); pdf.setFont('helvetica', 'bold'); pdf.text(`${sale.bultos} bulto(s)`, 45, y);

        pdf.save(`orden_tueste_${cliente.nombre.replace(/\s/g,'_')}_${sale.fecha}.pdf`);
    };

    window.generateStockPdf = (stockIndex) => {
        const item = stock[stockIndex];
        const cliente = clientes.find(c => c.id == item.clienteId);
        const tipoCafe = tiposCafe.find(t => t.id == item.tipoCafeId);
        if (!cliente || !tipoCafe) { alert('Faltan datos del cliente o del tipo de café.'); return; }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        let y = 15;

        pdf.setFontSize(18); pdf.text('Reporte de Detalle de Lote', 105, y, { align: 'center' }); y += 10;
        pdf.setFontSize(12); pdf.text(`Cliente: ${cliente.nombre}`, 14, y); y += 7;
        pdf.text(`Café: ${tipoCafe.nombre}`, 14, y); y += 15;
        
        pdf.setFontSize(14); pdf.text('Movimientos del Lote', 14, y); y += 10;
        pdf.setFontSize(10);
        item.movimientos.sort((a,b) => new Date(a.fecha) - new Date(b.fecha)).forEach(m => {
            pdf.text(`${formatDate(m.fecha)}: ${m.tipo}`, 16, y);
            pdf.text(`${m.kg.toFixed(2)} Kg`, 190, y, { align: 'right' });
            y += 7;
        });
        
        y += 5; pdf.line(14, y, 196, y); y += 10;
        pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
        pdf.text('Stock Restante:', 14, y);
        pdf.text(`${item.kgActuales.toFixed(2)} Kg`, 190, y, { align: 'right' });
        pdf.save(`stock_lote_${cliente.nombre.replace(/\s/g,'_')}.pdf`);
    };
    
    window.generateConsolidatedStockPdf = (clienteId) => {
        const cliente = clientes.find(c => c.id == clienteId);
        const stockCliente = stock.filter(s => s.clienteId == clienteId && s.kgActuales > 0.001);

        if (!cliente) { return; }
        if (stockCliente.length === 0) {
            alert('Este cliente no tiene stock para reportar.'); return;
        }

        const stockAgrupado = stockCliente.reduce((acc, lote) => {
            const tipoId = lote.tipoCafeId;
            if (!acc[tipoId]) {
                acc[tipoId] = {
                    kgTotales: 0,
                    // CORRECCIÓN: Usar '==' en lugar de '===' para comparar IDs de distinto tipo (número y texto).
                    tipoCafe: tiposCafe.find(t => t.id == tipoId)
                };
            }
            acc[tipoId].kgTotales += lote.kgActuales;
            return acc;
        }, {});

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        let y = 15, totalKgCliente = 0;

        pdf.setFontSize(18); pdf.text(`Reporte Consolidado de Stock`, 105, y, { align: 'center' }); y += 10;
        pdf.setFontSize(14); pdf.text(`Cliente: ${cliente.nombre}`, 14, y); y += 15;
        pdf.setFontSize(12); pdf.setFont('helvetica', 'bold');
        pdf.text('Resumen de Café Verde por Tipo', 14, y); y += 10;
        
        pdf.setFontSize(10);
        const cafesOrdenados = Object.values(stockAgrupado).sort((a, b) => {
            const nameA = a.tipoCafe ? a.tipoCafe.nombre : '';
            const nameB = b.tipoCafe ? b.tipoCafe.nombre : '';
            return nameA.localeCompare(nameB);
        });

        cafesOrdenados.forEach(grupo => {
            const nombreCafe = grupo.tipoCafe ? grupo.tipoCafe.nombre : 'DESCONOCIDO (TIPO ELIMINADO)';
            const kgTotales = grupo.kgTotales;

            pdf.setFont('helvetica', 'normal');
            pdf.text(nombreCafe, 16, y);
            pdf.text(`${kgTotales.toFixed(2)} Kg`, 190, y, { align: 'right' });
            totalKgCliente += kgTotales;
            y += 7;
        });
        
        y += 5; pdf.line(14, y, 196, y); y += 10;
        pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
        pdf.text('Total Stock Cliente:', 14, y);
        pdf.text(`${totalKgCliente.toFixed(2)} Kg`, 190, y, { align: 'right' });
        pdf.save(`stock_consolidado_${cliente.nombre.replace(/\s/g,'_')}.pdf`);
    };

    window.generateCuentaCorrientePdf = (clienteId) => {
        const cliente = clientes.find(c => c.id == clienteId);
        if (!cliente) return;

        const transacciones = [
            ...ventas.filter(v => v.clienteId == clienteId).map(v => ({ fecha: v.fecha, concepto: `Venta Tueste ${v.kg}Kg`, debito: v.totalARS, credito: 0 })),
            ...logistica.filter(l => l.clienteId == clienteId).map(l => ({ fecha: l.fecha, concepto: l.descripcion, debito: l.monto, credito: 0 })),
            ...cobros.filter(c => c.clienteId == clienteId).map(c => ({ fecha: c.fecha, concepto: 'Cobro', debito: 0, credito: c.monto }))
        ].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        if (transacciones.length === 0) {
            alert('Este cliente no tiene movimientos en su cuenta corriente.'); return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        let y = 15, saldo = 0;

        pdf.setFontSize(18); pdf.text('Estado de Cuenta Corriente', 105, y, { align: 'center' }); y += 10;
        pdf.setFontSize(12); pdf.text(`Cliente: ${cliente.nombre}`, 14, y); y += 7;
        pdf.text(`Fecha de Emisión: ${new Date().toLocaleDateString('es-AR')}`, 14, y); y += 15;
        pdf.setFontSize(10); pdf.setFont('helvetica', 'bold');
        pdf.text('Fecha', 14, y); pdf.text('Concepto', 40, y);
        pdf.text('Débito', 130, y, { align: 'right' });
        pdf.text('Crédito', 160, y, { align: 'right' });
        pdf.text('Saldo', 190, y, { align: 'right' });
        y += 7; pdf.line(14, y - 2, 196, y - 2);
        pdf.setFont('helvetica', 'normal');
        
        transacciones.forEach(t => {
            saldo += t.debito - t.credito;
            pdf.text(formatDate(t.fecha), 14, y);
            pdf.text(t.concepto.substring(0, 45), 40, y);
            pdf.text(t.debito > 0 ? formatCurrency(t.debito) : '', 130, y, { align: 'right' });
            pdf.text(t.credito > 0 ? formatCurrency(t.credito) : '', 160, y, { align: 'right' });
            pdf.text(formatCurrency(saldo), 190, y, { align: 'right' });
            y += 7;
            if (y > 280) { pdf.addPage(); y = 15; }
        });

        y += 5; pdf.line(14, y, 196, y); y += 10;
        pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
        pdf.text('Saldo Deudor Final:', 140, y, { align: 'right' });
        pdf.text(formatCurrency(saldo), 190, y, { align: 'right' });
        pdf.save(`cuenta_corriente_${cliente.nombre.replace(/\s/g,'_')}.pdf`);
    };

    // --- INITIALIZATION ---
    migrateStockDescriptions();
    renderUI();
    const today = new Date().toISOString().split('T')[0];
    ['ventaFecha', 'cobroFecha', 'stockFecha'].forEach(id => {
      const field = document.getElementById(id);
      if (field) field.value = today;
    });
});
</script>
</body>
</html>
